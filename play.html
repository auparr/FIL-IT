<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monster Pursuit - Quest Box Challenge</title>
    <link rel="stylesheet" href="CSS/game.css" />
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
  </head>
  <body>
    <div id="hpDisplay">HP: 3/3</div>
    <div id="gameArea">
      <div id="player"></div>
      <div id="gameOver">
        <h1>Game Over!</h1>
        <button id="restartBtn">Play Again</button>
        <button id="menuBtn">Back to Menu</button>
      </div>

      <!-- Math Question Modal -->
      <div id="mathQuestion">
        <div class="math-modal">
          <h2>Quick Math!</h2>
          <p>Answer correctly to escape the monster!</p>
          <div id="questionText" class="question"></div>
          <input type="number" id="answerInput" placeholder="Your answer..." />
          <div class="math-buttons">
            <button id="submitAnswer">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <div id="instructions">
      ðŸŽ¯ Reach the glowing Quest Box to win! Use arrow keys or WASD to move.
      Avoid monsters or answer math questions to escape!
    </div>
    <div id="legend">
      <span class="legend-item">
        <span class="legend-color patrol-color"></span>Patrolling
      </span>
      <span class="legend-item">
        <span class="legend-color chase-color"></span>Chasing You!
      </span>
      <span class="legend-item" style="color: #4ecdc4; font-weight: bold">
        âœ¨ Quest Box = Victory!
      </span>
    </div>

    <!-- Mobile Joystick -->
    <div class="joystick-container" id="joystick">
      <div class="joystick-knob" id="joystickKnob"></div>
    </div>

    <script src="/JS/game/controls/joyStick.js"></script>
    <script src="/JS/game/controls/keyMove.js"></script>

    <script src="/JS/game/core/gameLoop.js"></script>
    <script src="/JS/game/core/gameOver.js"></script>

    <script src="/JS/game/entities/monster.js"></script>
    <script src="/JS/game/entities/questBox.js"></script>

    <script src="/JS/game/mechanics/collision.js"></script>
    <script src="/JS/game/math.js"></script>

    <script src="/JS/game/quest/easy.js"></script>
    <script src="/JS/game/quest/medium.js"></script>
    <script src="/JS/game/quest/hard.js"></script>
    <script src="/JS/game/quest/advanced.js"></script>

    <script>
      const player = document.getElementById("player");
      const gameArea = document.getElementById("gameArea");
      const gameOverScreen = document.getElementById("gameOver");
      const restartBtn = document.getElementById("restartBtn");
      const menuBtn = document.getElementById("menuBtn");
      let viewportWidth = window.innerWidth;
      let monsterCount = 0;

      let gameRunning = true;

      if (viewportWidth <= 1024) {
        monsterCount = 5;
      } else {
        monsterCount = 9;
      }

      const monsterData = [];

      // Create player
      let posX = 100,
        posY = 100;
      const playerSpeed = 10;
      let keys = {};

      // Initialize game
      function initGame() {
        // Reset game state
        gameRunning = true;
        mathQuestionActive = false;
        window.isQuestBoxQuestion = false;
        gameOverScreen.style.display = "none";
        hideMathQuestion();

        // Reset HP system
        resetHP();

        // Remove any existing victory screen
        const existingVictory = document.getElementById("victoryScreen");
        if (existingVictory) {
          existingVictory.remove();
        }

        if (window.innerWidth <= 1300) {
          document.getElementById("joystick").style.display = "block";
        } else {
          document.getElementById("joystick").style.display = "none";
        }

        // Reset player position
        posX = 100;
        posY = 100;
        player.style.left = posX + "px";
        player.style.top = posY + "px";

        // Clear existing monsters and quest box
        monsterData.length = 0;
        document
          .querySelectorAll(".obstacle, .vision, .quest-box")
          .forEach((el) => el.remove());

        // Create new monsters
        createMonsters();

        // Create quest box
        createQuestBox();

        // Start game loop
        update();
      }

      // Restart game
      restartBtn.addEventListener("pointerdown", initGame);
      menuBtn.addEventListener("pointerdown", () => {
        window.location.href = "index.html";
      });

      // Submit answer button - handle both monster and quest box questions
      document
        .getElementById("submitAnswer")
        .addEventListener("pointerdown", () => {
          if (window.isQuestBoxQuestion) {
            checkQuestBoxAnswer();
          } else {
            checkAnswer();
          }
        });

      // Initialize joystick
      initJoystick();

      // Start the game
      initGame();
    </script>
  </body>
</html>
